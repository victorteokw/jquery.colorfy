(function(){var e,t,n,r,i,o,s,c,a,l,u,d,h,f,p,g;u={title:/^\s{0,3}\#{1,6}.*$/m,block:/^\s{0,3}>\s+.*$/m,orderedlist:/^\s*[0-9]+\. .+$/m,unorderedlist:/^\s*[*+-] .+$/m,strong:/([\*_]{2})[^\*_]+?\1/m,emphasis:/([\*_])[^\*_]+?\1(?![\*_])/m,strikethrough:/~~.+?~~/m,inlinecode:/`[^`\n]+?`/,codeblock:/```[.\n]+?```/m,rule:/^[-\*]{3,}/m},c=function(){var e;return e=window.navigator.userAgent,e.indexOf("MSIE ")>0?!0:!1},h=function(e){var t,n,r,i;if(Array.isArray(e))return e;r=[];for(n in e)i=e[n],t={},t[n]=i,r.unshift(t);return r},n=function(e,t,r,i){var o;return o={},o.content=e,o.htmlfier=t,o.descriptor=h(r),o.klass=i,o.subnodes=[],o.supernode=null,o.processed=!1,o.terminate=!1,o.toHTML=function(){var t,n,r,i,s;if(o.processed||o.process(),i=this.klass?"<span class='"+this.klass+"'>":"",e="",this.terminate)e+=this.htmlfier(this.content);else for(s=this.subnodes,n=0,r=s.length;r>n;n++)o=s[n],e+=o.toHTML();return t=this.klass?"</span>":"",i+e+t},o.process=function(){var e,t,r,s,c,a,l,u,d,h,f;if(0===this.descriptor.length)this.terminate=!0;else{d=this.descriptor.pop();for(i in d){for(l=d[i],e=0,u=this.content;r=l.exec(u);)t=!0,h=u.substr(e,r.index),s=r[0],e=s.length+r.index,u=u.substr(e),e=0,h.length>0&&(f=n(h,this.htmlfier,this.descriptor.slice(0),null),this.subnodes.push(f)),c=n(s,this.htmlfier,this.descriptor.slice(0),i),this.subnodes.push(c);a=n(u,this.htmlfier,this.descriptor.slice(0),null),this.subnodes.push(a)}}return o.processed=!0},o},s=function(e){return e=e.replace(/&/g,"&amp;"),e=e.replace(/</g,"&lt;"),e=e.replace(/>/g,"&gt;"),e=e.replace(/"/g,"&quot;"),e=e.replace(/'/g,"&apos;"),e=e.replace(/\//g,"&#x2F;"),e=e.replace(/\n/g,"<br>"),e=e.replace(new RegExp(" ","g"),"&nbsp;")},e=function(e,t,r){var i;return r||(r=s),i=n(e,r,t,"markdown"),i.toHTML()},i=function(t){return e(t,u,s)},o=function(e){return e=e.replace(/<(?!br|\/br).+?>/gm,""),e=e.replace(/<br>/g,"\n"),e=e.replace(/&lt;/g,"<"),e=e.replace(/&gt;/g,">"),e=e.replace(/&amp;/g,"&"),e=e.replace(/&quot;/g,'"'),e=e.replace(/&apos;/g,"'"),e=e.replace(/&#x2F/g,"/"),e=e.replace(/&nbsp;/g," ")},f=function(e){var t;for(t=[e];e=e.parentNode;)t.unshift(e);return t},t=function(e,t){var n,r,i,o,s;if(i=f(e),o=f(t),i[0]!==o[0])return null;for(n=r=0,s=i.length;s>r;n=r+=1)if(i[n]!==o[n])return i[n-1]},r=function(e,n,i,o){var s,c,u,d,h;if(o||(o=e),o===n)return l(n,i);if(!o.contains(n)&&e.contains(t(o,n))&&o.compareDocumentPosition(n)===Node.DOCUMENT_POSITION_FOLLOWING)return a(o);if(!o.contains(n)&&e.contains(t(o,n))&&o.compareDocumentPosition(n)===Node.DOCUMENT_POSITION_PRECEDING)return 0;if(o.contains(n)){for(d=0,h=o.childNodes,c=0,u=h.length;u>c;c++)s=h[c],d+=r(e,n,i,s);return d}},a=function(e){var t,n,r,i,o;if(e.nodeType===Node.TEXT_NODE)return e.nodeValue.length;if("BR"===e.tagName)return 1;if("SPAN"===e.tagName||"DIV"===e.tagName){for(i=0,o=e.childNodes,n=0,r=o.length;r>n;n++)t=o[n],i+=a(t);return i}},l=function(e,t){var n,r,i,o;if(e.nodeType===Node.TEXT_NODE)return t;if("BR"===e.tagName)return console.log("Is this correct behavior?"),t;if("SPAN"===e.tagName||"DIV"===e.tagName){for(i=0,n=r=0,o=t;o>r;n=r+=1)i+=a(e.childNodes[n]);return i}},d=function(e,t){var n,r,i,o;if(a(t)<e)return[];if(t.nodeType===Node.TEXT_NODE)return[t,e];if("BR"===t.tagName)return[t,e];for(o=t.childNodes,r=0,i=o.length;i>r;r++){if(n=o[r],!(a(n)<e))return d(e,n);e-=a(n)}},g=function(e){var t,n,i,o,s;return o=e[0],document.activeElement===o&&(s=window.getSelection(),s.isCollapsed&&(t=s.anchorNode,n=s.anchorOffset,o.contains(t)))?(i=r(o,t,n),e.data("cursorlocation",i)):void 0},p=function(e){var t,n,r,i,o;return r=e[0],document.activeElement===r&&(o=window.getSelection(),o.isCollapsed)?(i=d(e.data("cursorlocation"),r),t=i[0],n=i[1],t&&n>=0?o.collapse(t,n):void 0):void 0},$.fn.colorfy=function(e){var t,n;if(!c())return n=$("<div></div>"),n.attr("contenteditable","true"),n.attr("class",this.attr("class")),n.css("max-height",this.height()),n.css("height",this.height()),n.css("overflow","scroll"),this.after(n),this.css("display","none"),t=this,t.on("keyup paste",function(){return n.data("content",t.val()).trigger("receive-content")}),n.on("receive-content",function(){0===n.text().length?n.css("display","block"):n.css("display","inline-block"),n.html(i(n.data("content"))),p(n)}),n.on("send-content",function(){return 0===n.text().length?n.css("display","block"):n.css("display","inline-block"),t.val(n.data("content"))}),n.on("input paste",function(){return g(n),n.data("content",o(n.html())).trigger("send-content").trigger("receive-content")}),n.data("content",this.val()).trigger("receive-content")}}).call(this);